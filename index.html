<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Portal de acceso seguro al Sistema SDMO" />
  <meta name="theme-color" content="#1e293b" />
  <meta name="robots" content="noindex, nofollow" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <title>Acceso Seguro - SDMO</title>

  <!-- Tu CSS (si lo usas) -->
  <link rel="stylesheet" href="public/app.css" />

  <!-- Config centralizada con SUPABASE_URL y SUPABASE_ANON_KEY -->
  <script src="public/config.js"></script>

  <style>
    :root {
      --primary-color:#60a5fa; --primary-dark:#3b82f6; --primary-light:#93c5fd;
      --text-color:#f1f5f9; --text-secondary:#94a3b8;
      --error-color:#f87171; --success-color:#34d399; --warning-color:#fbbf24;
      --background-color:#0f172a; --card-background:#1e293b; --border-color:#334155;
      --shadow-color:rgba(0,0,0,.4); --shadow-hover:rgba(0,0,0,.6);
      --focus-shadow:rgba(96,165,250,.4); --focus-ring:0 0 0 3px var(--focus-shadow);
      --border-radius:12px; --transition:.3s cubic-bezier(.4,0,.2,1);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:'Inter',system-ui,Segoe UI,Roboto,Arial,sans-serif;
      background:linear-gradient(135deg,var(--background-color) 0%,#0c1420 100%);
      min-height:100vh; display:flex; align-items:center; justify-content:center;
      padding:20px; color:var(--text-color); line-height:1.6; transition:var(--transition);
    }
    .page-loader{position:fixed;top:0;left:0;width:100%;height:4px;background:linear-gradient(90deg,var(--primary-color),var(--primary-light));transform:translateX(-100%);animation:pl 2s ease-out forwards;z-index:1000}
    @keyframes pl{to{transform:translateX(0)}}
    .login-container{width:100%;max-width:420px;text-align:center;animation:fadeInUp .6s ease-out}
    @keyframes fadeInUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
    .system-title{
      background:linear-gradient(135deg,var(--primary-color),var(--primary-light));
      -webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;
      font-size:28px;font-weight:700;margin-bottom:8px;letter-spacing:-.02em
    }
    .system-subtitle{color:var(--text-secondary);font-size:16px;margin-bottom:32px}
    .login-form{
      background:var(--card-background); padding:40px 32px; border-radius:var(--border-radius);
      box-shadow:0 10px 25px -5px var(--shadow-color),0 8px 10px -6px var(--shadow-color);
      border:1px solid var(--border-color); transition:var(--transition); backdrop-filter:blur(10px);
      animation:fadeInUp .8s ease-out .2s both;
    }
    .login-form:hover{box-shadow:0 20px 25px -5px var(--shadow-hover),0 8px 10px -6px var(--shadow-hover);border-color:#475569}
    .form-group{margin-bottom:24px;text-align:left}
    .form-label{display:block;margin-bottom:8px;font-weight:500;color:var(--text-color);font-size:14px}
    .form-label.required::after{content:' *';color:var(--error-color)}
    .form-input{
      width:100%;padding:14px 16px;font-size:16px;border-radius:8px;border:2px solid var(--border-color);
      background:#0f172a;color:var(--text-color);transition:var(--transition)
    }
    .form-input::placeholder{color:#64748b;opacity:.8}
    .form-input:focus{outline:none;border-color:var(--primary-color);box-shadow:var(--focus-ring);background:#1e293b}
    .password-container{position:relative}
    .password-toggle{
      position:absolute;right:12px;top:50%;transform:translateY(-50%);
      background:none;border:none;color:var(--text-secondary);cursor:pointer;padding:8px;border-radius:4px
    }
    .password-toggle:hover{color:var(--text-color);background:rgba(148,163,184,.1)}
    .password-strength{font-size:12px;margin-top:4px;font-weight:500;display:none}
    .form-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;font-size:14px}
    .checkbox-group{display:flex;align-items:center;gap:8px}
    .form-checkbox{width:18px;height:18px;cursor:pointer;accent-color:var(--primary-color)}
    .submit-button{
      width:100%;padding:16px;font-size:16px;font-weight:600;border-radius:8px;color:#fff;border:none;cursor:pointer;
      background:linear-gradient(135deg,var(--primary-color),var(--primary-dark));
      display:flex;align-items:center;justify-content:center;gap:8px;position:relative;overflow:hidden;transition:var(--transition)
    }
    .submit-button::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;
      background:linear-gradient(90deg,transparent,rgba(255,255,255,.2),transparent);transition:left .5s}
    .submit-button:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 8px 25px rgba(96,165,250,.4)}
    .submit-button:hover::before{left:100%}
    .submit-button:disabled{opacity:.7;cursor:not-allowed}
    .error-message{
      color:var(--error-color);font-size:14px;text-align:center;padding:12px;margin-bottom:16px;border-radius:8px;
      background:rgba(248,113,113,.1);border:1px solid rgba(248,113,113,.3);display:none
    }
    .error-shake{animation:shake .5s cubic-bezier(.36,.07,.19,.97)}
    @keyframes shake{10%,90%{transform:translate3d(-1px,0,0)}20%,80%{transform:translate3d(2px,0,0)}30%,50%,70%{transform:translate3d(-4px,0,0)}40%,60%{transform:translate3d(4px,0,0)}}
    .loader{display:inline-block;width:18px;height:18px;border:2px solid rgba(255,255,255,.3);border-radius:50%;border-top-color:#fff;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .footer{margin-top:32px;text-align:center}
    .footer small{color:var(--text-secondary)}
    .screen-reader-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    @media (max-width:480px){
      body{padding:16px}
      .login-form{padding:24px 20px}
      .system-title{font-size:24px}
      .system-subtitle{font-size:14px}
      .form-row{flex-direction:column;gap:12px;align-items:flex-start}
    }
  </style>
</head>
<body>
  <!-- Indicador de carga de página -->
  <div class="page-loader"></div>

  <!-- Anunciador para lectores de pantalla -->
  <div id="screenReaderAnnouncer" class="screen-reader-only" aria-live="polite" aria-atomic="true"></div>

  <div class="login-container">
    <h1 class="system-title">SDMO</h1>
    <p class="system-subtitle">Sistema de Gestión Administrativa</p>

    <form id="loginForm" class="login-form" novalidate>
      <div class="form-group">
        <label for="email" class="form-label required">Correo electrónico</label>
        <input id="email" type="email" class="form-input" placeholder="usuario@dominio.com"
               required autocomplete="username" autocapitalize="none" autocorrect="off" spellcheck="false" maxlength="254" />
      </div>

      <div class="form-group">
        <label for="password" class="form-label required">Contraseña</label>
        <div class="password-container">
          <input id="password" type="password" class="form-input" placeholder="••••••••••••"
                 required autocomplete="current-password" minlength="8" maxlength="128" aria-describedby="passwordStrength" />
          <button type="button" id="passwordToggle" class="password-toggle" aria-label="Mostrar contraseña" tabindex="-1">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle>
            </svg>
          </button>
        </div>
        <div id="passwordStrength" class="password-strength"></div>
      </div>

      <div class="form-row">
        <div class="checkbox-group">
          <input type="checkbox" id="rememberMe" class="form-checkbox" />
          <label for="rememberMe">Recordar en este dispositivo</label>
        </div>
      </div>

      <div id="errorMsg" class="error-message" role="alert" aria-live="assertive"></div>

      <button type="submit" id="submitBtn" class="submit-button">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
          <polyline points="10,17 15,12 10,7"></polyline>
          <line x1="15" y1="12" x2="3" y2="12"></line>
        </svg>
        Iniciar Sesión
      </button>
    </form>

    <footer class="footer">
      <small>&copy; 2025 Sistema SDMO. Versión 2.1.0 — Última actualización: Mayo 2025</small>
    </footer>
  </div>

  <div id="toastContainer" class="toast-container" aria-live="polite" aria-atomic="true"></div>

  <!-- Lógica: usar SOLO módulos (sin script global de supabase) -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // Config desde public/config.js
    const { SUPABASE_URL, SUPABASE_ANON_KEY } = window.SDMO_CONFIG || {};
    const CONFIG = {
      supabaseUrl: SUPABASE_URL,
      supabaseKey: SUPABASE_ANON_KEY,
      redirectUrl: 'inicio.html',
      maxAttempts: 5,
      lockoutTime: 15 * 60 * 1000,
      sessionTimeout: 60 * 60 * 1000
    };

    if (!CONFIG.supabaseUrl || !CONFIG.supabaseKey) {
      alert('Falta configurar public/config.js con SUPABASE_URL y SUPABASE_ANON_KEY');
    }

    const supabase = createClient(CONFIG.supabaseUrl, CONFIG.supabaseKey);

    /* ------------------ Utilidades de seguridad ------------------ */
    const SecurityUtils = {
      sanitizeInput(s){ return s.trim().replace(/[<>]/g,''); },
      isValidEmail(e){
        const r=/^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;
        return r.test(e) && e.length<=254;
      },
      validatePassword(p){ return { isValid: p.length>=8, message: p.length<8 ? 'La contraseña debe tener al menos 8 caracteres' : '' }; },
      getFailedAttempts(){
        const a=JSON.parse(localStorage.getItem('sdmo_failed_attempts')||'{}'), now=Date.now();
        Object.keys(a).forEach(t=>{ if(now-parseInt(t)>CONFIG.lockoutTime) delete a[t]; });
        localStorage.setItem('sdmo_failed_attempts',JSON.stringify(a));
        return Object.keys(a).length;
      },
      addFailedAttempt(){ const a=JSON.parse(localStorage.getItem('sdmo_failed_attempts')||'{}'); a[Date.now()]=true; localStorage.setItem('sdmo_failed_attempts',JSON.stringify(a)); },
      clearFailedAttempts(){ localStorage.removeItem('sdmo_failed_attempts'); },
      isAccountLocked(){ return this.getFailedAttempts()>=CONFIG.maxAttempts; },
      getRemainingLockoutTime(){
        const a=JSON.parse(localStorage.getItem('sdmo_failed_attempts')||'{}');
        const ts=Object.keys(a).map(t=>+t).sort((x,y)=>y-x);
        if(!ts.length) return 0;
        const oldest = ts[CONFIG.maxAttempts-1];
        return Math.max(0, CONFIG.lockoutTime - (Date.now()-oldest));
      }
    };

    /* ------------------ Gestión de sesión (cliente) ------------------ */
    const SessionManager = {
      setSession(user){
        sessionStorage.setItem('sdmo_session', JSON.stringify({ user:{ id:user.id, email:user.email, lastActivity:Date.now() }, loginTime:Date.now() }));
      },
      isSessionValid(){
        const s=sessionStorage.getItem('sdmo_session'); if(!s) return false;
        try{ const d=JSON.parse(s); return (Date.now()-d.user.lastActivity)<CONFIG.sessionTimeout; }catch{return false}
      }
    };

    const announcer = (msg,prio='polite')=>{
      const el=document.getElementById('screenReaderAnnouncer');
      el.setAttribute('aria-live', prio); el.textContent=msg;
      setTimeout(()=>{ el.textContent=''; }, 1000);
    };

    /* ------------------ App ------------------ */
    function initApp(){
      const els={
        form:document.getElementById('loginForm'),
        email:document.getElementById('email'),
        pass:document.getElementById('password'),
        toggle:document.getElementById('passwordToggle'),
        remember:document.getElementById('rememberMe'),
        strength:document.getElementById('passwordStrength'),
        error:document.getElementById('errorMsg'),
        submit:document.getElementById('submitBtn')
      };

      // Recordar email
      const savedEmail=localStorage.getItem('sdmo_email'), savedRemember=localStorage.getItem('sdmo_remember');
      if(savedEmail && savedRemember==='true'){ els.email.value=savedEmail; els.remember.checked=true; els.pass.focus(); } else { els.email.focus(); }

      // Si hay sesión válida (cliente), redirige
      if(SessionManager.isSessionValid()) window.location.href=CONFIG.redirectUrl;

      // Real-time
      els.email.addEventListener('input',()=>{ clearError(); validateEmailField(); });
      els.pass.addEventListener('input',e=>{ clearError(); updateStrength(e.target.value); });

      // Toggle password
      els.toggle.addEventListener('click', ()=>{
        const isPwd = els.pass.type==='password';
        els.pass.type = isPwd ? 'text' : 'password';
        announcer(isPwd?'Contraseña visible':'Contraseña oculta');
      });

      // Submit
      let lastSubmit=0;
      els.form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const now=Date.now(); if(now-lastSubmit<1000){ showError('Por favor espere un momento antes de intentar nuevamente'); return; }
        lastSubmit=now;

        // Lockout
        if(SecurityUtils.isAccountLocked()){
          const rt = SecurityUtils.getRemainingLockoutTime();
          if(rt>0){ showAccountLocked(rt); return; } else { SecurityUtils.clearFailedAttempts(); }
        }

        const email=SecurityUtils.sanitizeInput(els.email.value), pass=els.pass.value;
        if(!email || !pass){ showError('Por favor complete todos los campos requeridos'); announcer('Error: Campos incompletos','assertive'); return; }
        if(!SecurityUtils.isValidEmail(email)){ showError('Por favor ingrese un correo electrónico válido'); els.email.focus(); return; }
        const pv=SecurityUtils.validatePassword(pass); if(!pv.isValid){ showError(pv.message); els.pass.focus(); return; }

        showLoading(true);
        try{
          // Guardar preferencia
          if(els.remember.checked){ localStorage.setItem('sdmo_email',email); localStorage.setItem('sdmo_remember','true'); }
          else { localStorage.removeItem('sdmo_email'); localStorage.removeItem('sdmo_remember'); }

          const { data, error } = await supabase.auth.signInWithPassword({ email, password:pass });
          if(error) throw error;

          SecurityUtils.clearFailedAttempts();
          SessionManager.setSession(data.user);
          announcer('Inicio de sesión exitoso. Redirigiendo...','assertive');
          setTimeout(()=>{ window.location.href=CONFIG.redirectUrl; }, 500);
        }catch(err){
          console.error(err);
          SecurityUtils.addFailedAttempt();
          let msg='Error al iniciar sesión. Intente nuevamente.';
          if(String(err.message).includes('Email not confirmed')) msg='Correo electrónico no verificado. Revise su bandeja de entrada.';
          else if(String(err.message).includes('Invalid login credentials')){
            const rem = CONFIG.maxAttempts - SecurityUtils.getFailedAttempts();
            msg = rem>0 ? `Credenciales incorrectas. Le quedan ${rem} intentos.` : 'Cuenta temporalmente bloqueada por seguridad.';
            if(rem<=0){ showAccountLocked(CONFIG.lockoutTime); showLoading(false); return; }
          } else if(String(err.message).includes('Too many requests')) msg='Demasiados intentos. Espere unos minutos antes de intentar nuevamente.';
          showError(msg); announcer(`Error: ${msg}`,'assertive');
        } finally {
          showLoading(false);
        }
      });

      function validateEmailField(){
        const isValid = SecurityUtils.isValidEmail(SecurityUtils.sanitizeInput(els.email.value));
        els.email.setAttribute('aria-invalid', !isValid);
        els.email.style.borderColor = isValid || !els.email.value ? 'var(--border-color)' : 'var(--error-color)';
      }

      function updateStrength(p){
        const el=els.strength;
        if(!p){ el.style.display='none'; return; }
        let s=0, fb=[];
        if(p.length>=8) s++; else fb.push('Mínimo 8 caracteres');
        if(/[a-z]/.test(p)) s++; else fb.push('Una minúscula');
        if(/[A-Z]/.test(p)) s++; else fb.push('Una mayúscula');
        if(/\d/.test(p)) s++; else fb.push('Un número');
        if(/[^a-zA-Z\d]/.test(p)) s++; else fb.push('Un carácter especial');
        const levels=['Muy débil','Débil','Regular','Buena','Fuerte'], colors=['#e74c3c','#f39c12','#f1c40f','#27ae60','#2ecc71'];
        el.textContent=`Fortaleza: ${levels[s]}`; el.style.color=colors[s]; el.style.display='block'; el.title = fb.length ? `Falta: ${fb.join(', ')}` : '';
      }

      function showError(m){ els.error.textContent=m; els.error.style.display='block'; els.error.classList.add('error-shake'); setTimeout(()=>els.error.classList.remove('error-shake'),500); els.error.scrollIntoView({behavior:'smooth',block:'nearest'}); }
      function clearError(){ els.error.textContent=''; els.error.style.display='none'; }
      function showLoading(on){ els.submit.disabled=on; els.submit.innerHTML = on ? 'Verificando credenciales <span class="loader"></span>' : els.submit.dataset.label || 'Iniciar Sesión'; }

      function showAccountLocked(rt){
        const mins=Math.ceil(rt/60000);
        showError(`Cuenta temporalmente bloqueada por seguridad. Intente nuevamente en ${mins} minuto${mins!==1?'s':''}.`);
        els.submit.disabled = true;
        const iv=setInterval(()=>{
          const r=SecurityUtils.getRemainingLockoutTime();
          if(r<=0){ clearInterval(iv); clearError(); els.submit.disabled=false; SecurityUtils.clearFailedAttempts(); announcer('Cuenta desbloqueada. Puede intentar nuevamente.'); }
        }, 30000);
      }
    }

    function checkBrowserCompatibility(){
      const req=['fetch','Promise','localStorage','sessionStorage'];
      const bad=req.filter(f=>!(f in window));
      if(bad.length){
        document.body.innerHTML=`<div style="text-align:center;padding:50px"><h2>Navegador no compatible</h2><p>Actualice su navegador.</p><p><small>Faltan: ${bad.join(', ')}</small></p></div>`;
        return false;
      }
      return true;
    }

    if(document.readyState==='loading'){
      document.addEventListener('DOMContentLoaded', ()=>{ if(checkBrowserCompatibility()) initApp(); });
    } else { if(checkBrowserCompatibility()) initApp(); }

    // Quitar loader visual al cargar
    window.addEventListener('load', ()=>{ setTimeout(()=>{ const l=document.querySelector('.page-loader'); if(l) l.style.display='none'; }, 500); });
  </script>

  <!-- Utilidades varias no críticas -->
  <script>
    // Toasts simples (opcional)
    function showToast(msg,type='info',ms=5000){
      const container=document.getElementById('toastContainer');
      const el=document.createElement('div');
      el.className=`toast ${type}`;
      el.style.cssText='background:#1e293b;border:1px solid #334155;border-radius:8px;padding:12px 14px;margin:8px 0;box-shadow:0 8px 25px rgba(0,0,0,.4);transform:translateX(100%);transition:transform .3s ease;color:#fff;';
      el.textContent=msg; container.appendChild(el);
      requestAnimationFrame(()=> el.style.transform='translateX(0)');
      setTimeout(()=>{ el.style.transform='translateX(100%)'; setTimeout(()=>el.remove(),300); }, ms);
    }
    window.addEventListener('online', ()=>showToast('Conexión restablecida','success',2500));
    window.addEventListener('offline', ()=>showToast('Sin conexión a internet','warning',3500));

    // Inactividad (cliente)
    let inactivityTimer; const INACT=30*60*1000;
    function resetInactivity(){ clearTimeout(inactivityTimer); inactivityTimer=setTimeout(()=>{ sessionStorage.clear(); showToast('Sesión expirada por inactividad','warning',4000); }, INACT); }
    ['mousedown','mousemove','keypress','scroll','touchstart'].forEach(e=>document.addEventListener(e, resetInactivity, true)); resetInactivity();
  </script>
</body>
</html>








